<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Autenticação Híbrida (Experimental)</title>
<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f4f4f4;
        margin: 0;
    }
    .container {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 400px;
        text-align: center;
    }
    h1 {
        color: #333;
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
        text-align: left;
    }
    label {
        display: block;
        margin-bottom: 5px;
        color: #555;
    }
    input[type="text"],
    input[type="password"],
    textarea {
        width: calc(100% - 20px);
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    button:hover {
        background-color: #0056b3;
    }
    .message {
        margin-top: 20px;
        color: green;
        font-weight: bold;
    }
    .error {
        color: red;
    }
    .hidden {
        display: none;
    }
    /* Slider specific styles */
    .slider-container {
        width: 100%;
        margin-top: 20px;
        text-align: center;
    }
    .slider {
        -webkit-appearance: none;
        width: 80%;
        height: 15px;
        border-radius: 5px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
    }
    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
    }
    #sliderValue {
        margin-top: 10px;
        font-weight: bold;
    }
</style>
</head>
<body>
<div class="container">
    <div id="login-section">
        <h1>Login</h1>
        <div class="form-group">
            <label for="username">Usuário:</label>
            <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
            <label for="password">Senha:</label>
            <input type="password" id="password" name="password" required>
        </div>
        <button id="loginButton">Entrar</button>
        <p id="loginMessage" class="message"></p>
    </div>

    <div id="challenge-section" class="hidden">
        <h1>Desafio Comportamental</h1>
        <p>Por favor, complete os desafios para verificar sua identidade.</p>

        <div id="slider-challenge" class="hidden">
            <p>Desafio 1: Arraste o slider para o valor 75.</p>
            <div class="slider-container">
                <input type="range" min="0" max="100" value="50" class="slider" id="mySlider">
                <p>Valor: <span id="sliderValue">50</span></p>
            </div>
            <button id="submitSlider">Confirmar Slider</button>
        </div>

        <div id="phrase-challenge" class="hidden">
            <p>Desafio 2: Digite a seguinte frase:</p>
            <p><strong>"A rápida raposa marrom salta sobre o cão preguiçoso."</strong></p>
            <textarea id="phraseInput" rows="3" placeholder="Digite a frase aqui..."></textarea>
            <button id="submitPhrase">Confirmar Frase</button>
        </div>
        <p id="challengeMessage" class="message"></p>
    </div>

    <div id="success-section" class="hidden">
        <h1>Login Bem-Sucedido!</h1>
        <p>Bem-vindo ao sistema experimental.</p>
    </div>
</div>

<script>
    // --- Usuários Hardcoded (APENAS PARA SIMULAÇÃO!) ---
    const users = [
        { username: "usuario1", password: "senha123", profile: "normal" },
        { username: "usuario2", password: "abcde", profile: "rapido" },
        { username: "usuario3", password: "teste", profile: "lento" },
        { username: "admin", password: "adminpass", profile: "normal" }
    ];

    // --- Variáveis para Coleta de Dados ---
    let usernameInput = document.getElementById('username');
    let passwordInput = document.getElementById('password');
    let loginButton = document.getElementById('loginButton');
    let loginMessage = document.getElementById('loginMessage');

    let mySlider = document.getElementById('mySlider');
    let sliderValueSpan = document.getElementById('sliderValue');
    let submitSliderButton = document.getElementById('submitSlider');

    let phraseInput = document.getElementById('phraseInput');
    let submitPhraseButton = document.getElementById('submitPhrase');

    // Seções da UI
    let loginSection = document.getElementById('login-section');
    let challengeSection = document.getElementById('challenge-section');
    let sliderChallenge = document.getElementById('slider-challenge');
    let phraseChallenge = document.getElementById('phrase-challenge');
    let successSection = document.getElementById('success-section');

    // Dados comportamentais da senha
    let passwordKeystrokes = []; // {key: 'a', type: 'keydown/keyup', timestamp: Date.now()}
    let passwordStartTime = 0;
    let passwordEndTime = 0;

    // Dados comportamentais do mouse (geral)
    let mouseMovements = []; // {x: 100, y: 200, timestamp: Date.now()}
    let lastMouseMoveTime = 0;

    // Dados comportamentais do slider
    let sliderMovements = []; // {value: 50, timestamp: Date.now()}
    let sliderStartTime = 0;
    let sliderEndTime = 0;

    // Dados comportamentais da frase
    let phraseKeystrokes = [];
    let phraseStartTime = 0;
    let phraseEndTime = 0;
    let phraseBackspaceCount = 0;

    const TARGET_PHRASE = "A rápida raposa marrom salta sobre o cão preguiçoso.";

    // --- Funções de Coleta de Eventos ---

    // Captura movimentos do mouse em todo o documento
    document.addEventListener('mousemove', (e) => {
        const now = Date.now();
        // Captura a cada 50ms para não sobrecarregar
        if (now - lastMouseMoveTime > 50) {
            mouseMovements.push({ x: e.clientX, y: e.clientY, timestamp: now });
            lastMouseMoveTime = now;
        }
    });

    // Captura dinâmica de digitação da senha
    passwordInput.addEventListener('keydown', (e) => {
        if (passwordStartTime === 0) passwordStartTime = Date.now();
        passwordKeystrokes.push({ key: e.key, type: 'keydown', timestamp: Date.now() });
    });
    passwordInput.addEventListener('keyup', (e) => {
        passwordKeystrokes.push({ key: e.key, type: 'keyup', timestamp: Date.now() });
        passwordEndTime = Date.now(); // Atualiza continuamente para pegar o último keyup
    });

    // Captura dinâmica do slider
    mySlider.addEventListener('mousedown', () => {
        sliderStartTime = Date.now();
        sliderMovements = []; // Limpa movimentos anteriores
    });
    mySlider.addEventListener('input', () => {
        sliderValueSpan.textContent = mySlider.value;
        sliderMovements.push({ value: mySlider.value, timestamp: Date.now() });
    });
    mySlider.addEventListener('mouseup', () => {
        sliderEndTime = Date.now();
    });

    // Captura dinâmica de digitação da frase
    phraseInput.addEventListener('keydown', (e) => {
        if (phraseStartTime === 0) phraseStartTime = Date.now();
        phraseKeystrokes.push({ key: e.key, type: 'keydown', timestamp: Date.now() });
        if (e.key === 'Backspace') {
            phraseBackspaceCount++;
        }
    });
    phraseInput.addEventListener('keyup', (e) => {
        phraseKeystrokes.push({ key: e.key, type: 'keyup', timestamp: Date.now() });
        phraseEndTime = Date.now();
    });

    // --- Lógica de Autenticação e Desafios ---

    loginButton.addEventListener('click', () => {
        const username = usernameInput.value;
        const password = passwordInput.value;

        // Simulação de verificação de hash (em um sistema real, isso seria no backend)
        const foundUser = users.find(u => u.username === username && u.password === password);

        if (foundUser) {
            loginMessage.textContent = "Senha correta. Iniciando desafio comportamental...";
            loginMessage.className = 'message';
            
            // Coleta de dados da senha
            const passwordTotalTime = passwordEndTime - passwordStartTime;
            const passwordKeystrokeDynamics = calculateKeystrokeDynamics(passwordKeystrokes);

            console.log("--- Dados da Senha ---");
            console.log("Usuário:", username);
            console.log("Tempo Total de Digitação:", passwordTotalTime, "ms");
            console.log("Dinâmica de Digitação:", passwordKeystrokeDynamics);
            console.log("Movimentos do Mouse (geral):", mouseMovements); // Estes seriam filtrados para a área da senha no backend

            // Transiciona para a seção de desafios
            loginSection.classList.add('hidden');
            challengeSection.classList.remove('hidden');
            sliderChallenge.classList.remove('hidden');

            // Resetar dados do mouse para o próximo desafio, se necessário
            mouseMovements = []; 
            lastMouseMoveTime = 0;

        } else {
            loginMessage.textContent = "Usuário ou senha incorretos.";
            loginMessage.className = 'message error';
        }
    });

    submitSliderButton.addEventListener('click', () => {
        const sliderValue = parseInt(mySlider.value);
        const sliderTotalTime = sliderEndTime - sliderStartTime;
        
        console.log("--- Dados do Slider ---");
        console.log("Valor Final do Slider:", sliderValue);
        console.log("Tempo Total do Slider:", sliderTotalTime, "ms");
        console.log("Movimentos do Slider:", sliderMovements);
        console.log("Movimentos do Mouse (durante slider):", mouseMovements);

        // Simulação de validação do slider (em um sistema real, seria análise comportamental)
        // Aqui, podemos adicionar uma validação mais "inteligente" baseada no perfil do usuário
        // Por exemplo, usuario2 pode ser mais rápido, usuario3 mais lento.
        const currentUser = users.find(u => u.username === usernameInput.value);
        let sliderValidationPassed = false;

        if (sliderValue === 75) {
            if (currentUser.profile === "rapido" && sliderTotalTime < 1000) { // Ex: espera que seja rápido
                sliderValidationPassed = true;
            } else if (currentUser.profile === "lento" && sliderTotalTime > 2000) { // Ex: espera que seja lento
                sliderValidationPassed = true;
            } else if (currentUser.profile === "normal" && sliderTotalTime > 500 && sliderTotalTime < 5000) { // Ex: normal
                sliderValidationPassed = true;
            }
        }

        if (sliderValidationPassed) {
            document.getElementById('challengeMessage').textContent = "Slider OK. Próximo desafio...";
            document.getElementById('challengeMessage').className = 'message';
            sliderChallenge.classList.add('hidden');
            phraseChallenge.classList.remove('hidden');

            // Resetar dados do mouse para o próximo desafio
            mouseMovements = []; 
            lastMouseMoveTime = 0;

        } else {
            document.getElementById('challengeMessage').textContent = "Desafio do Slider falhou. Tente novamente.";
            document.getElementById('challengeMessage').className = 'message error';
            // Reiniciar o slider para nova tentativa
            mySlider.value = 50;
            sliderValueSpan.textContent = 50;
            sliderStartTime = 0;
            sliderEndTime = 0;
            sliderMovements = [];
        }
    });

    submitPhraseButton.addEventListener('click', () => {
        const typedPhrase = phraseInput.value;
        const phraseTotalTime = phraseEndTime - phraseStartTime;
        const phraseKeystrokeDynamics = calculateKeystrokeDynamics(phraseKeystrokes);

        console.log("--- Dados da Frase ---");
        console.log("Frase Digitada:", typedPhrase);
        console.log("Tempo Total da Frase:", phraseTotalTime, "ms");
        console.log("Dinâmica de Digitação da Frase:", phraseKeystrokeDynamics);
        console.log("Contagem de Backspace:", phraseBackspaceCount);
        console.log("Movimentos do Mouse (durante frase):", mouseMovements);

        // Simulação de validação da frase (em um sistema real, seria análise comportamental)
        const currentUser = users.find(u => u.username === usernameInput.value);
        let phraseValidationPassed = false;

        if (typedPhrase === TARGET_PHRASE) {
            if (currentUser.profile === "rapido" && phraseTotalTime < 5000) { // Ex: espera que seja rápido
                phraseValidationPassed = true;
            } else if (currentUser.profile === "lento" && phraseTotalTime > 8000) { // Ex: espera que seja lento
                phraseValidationPassed = true;
            } else if (currentUser.profile === "normal" && phraseTotalTime > 2000 && phraseTotalTime < 10000) { // Ex: normal
                phraseValidationPassed = true;
            }
        }

        if (phraseValidationPassed) {
            document.getElementById('challengeMessage').textContent = "Frase OK. Login bem-sucedido!";
            document.getElementById('challengeMessage').className = 'message';
            challengeSection.classList.add('hidden');
            successSection.classList.remove('hidden');
        } else {
            document.getElementById('challengeMessage').textContent = "Desafio da Frase falhou. Verifique a frase e o tempo.";
            document.getElementById('challengeMessage').className = 'message error';
            // Reiniciar a frase para nova tentativa
            phraseInput.value = '';
            phraseStartTime = 0;
            phraseEndTime = 0;
            phraseKeystrokes = [];
            phraseBackspaceCount = 0;
        }
    });

    // --- Funções Auxiliares para Cálculo de Dinâmica de Digitação ---
    function calculateKeystrokeDynamics(keystrokes) {
        const dynamics = [];
        let lastKeyDownTime = {}; // Para dwell time
        let lastKeyUpTime = null;   // Para flight time

        for (let i = 0; i < keystrokes.length; i++) {
            const current = keystrokes[i];

            if (current.type === 'keydown') {
                lastKeyDownTime[current.key] = current.timestamp;
            } else if (current.type === 'keyup') {
                const key = current.key;
                const dwellTime = current.timestamp - (lastKeyDownTime[key] || current.timestamp);
                
                let flightTime = 0;
                if (lastKeyUpTime !== null) {
                    flightTime = current.timestamp - lastKeyUpTime;
                }
                lastKeyUpTime = current.timestamp;

                dynamics.push({
                    key: key,
                    dwell_time: dwellTime,
                    flight_time: flightTime
                });
            }
        }
        return dynamics;
    }

    // Para uma análise real, você enviaria os dados coletados para o backend
    function sendBehavioralData(data) {
        // Exemplo de como você enviaria os dados para um endpoint no seu servidor
        /*
        fetch('/api/behavioral-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => console.log('Dados enviados com sucesso:', data))
        .catch((error) => console.error('Erro ao enviar dados:', error));
        */
        console.log("Dados comportamentais prontos para envio:", data);
    }

    // Exemplo de uso:
    // sendBehavioralData({
    //     username: usernameInput.value,
    //     passwordMetrics: {
    //         totalTime: passwordTotalTime,
    //         keystrokeDynamics: passwordKeystrokeDynamics
    //     },
    //     sliderMetrics: {
    //         totalTime: sliderTotalTime,
    //         movements: sliderMovements
    //     },
    //     phraseMetrics: {
    //         totalTime: phraseTotalTime,
    //         keystrokeDynamics: phraseKeystrokeDynamics,
    //         backspaceCount: phraseBackspaceCount
    //     },
    //     mouseMovements: mouseMovements // Movimentos gerais do mouse
    // });

</script>
</body>
</html>